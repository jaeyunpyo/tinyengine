
// #include "../inc/testInput.h    "

#include <stdlib.h>
#include "stm32746g_discovery.h"
#include "stm32f7xx_hal.h"
#include "../inc/undefined.h"
#include "profile.h"

#define FLASH_BUFF_SIZE 128

#define SLAVE_STACK_SIZE 2048
#define STACK_SIZE      2048

int8_t testInputVectorInput[256] ={106, 99, -121, -125, -110, -86, -107, 108, -115, 111, -46, 69, -94, -127, 12, 84, 1, -2, 79, -34, 113, 52, -120, -81, -124, 98, 49, 46, -19, -86, -78, -82, -105, -116, 16, 37, -61, 48, 87, 73, 61, -8, 4, 0, 107, 57, -102, 92, -78, -27, 104, 102, -64, 107, -90, 6, -16, -43, -109, -22, -4, -23, -8, -56, -49, -117, -85, -34, 102, -113, -43, -65, -111, -85, -21, 72, 4, -54, -14, -10, 54, -23, 74, -15, -110, -35, 41, -123, 124, -12, 73, 55, 0, -28, 51, -98, -77, 93, -104, -99, -71, 117, 6, 88, 63, 55, -40, 79, 98, -55, -101, -9, 29, 99, -9, -81, 124, -41, -81, -70, -32, -60, -28, 27, -54, 76, 74, -47, 118, -82, -95, 28, 89, 58, -11, 97, -50, -30, -103, 112, -14, 69, 82, -70, 93, 82, -118, 107, -104, 20, -117, 69, -120, 25, 46, -6, 6, 31, -99, 8, -8, 4, -128, -110, 88, -57, 48, 121, 104, -15, -51, -73, -15, -93, -64, -110, 22, -96, -7, -53, 61, 12, -2, 36, 5, -48, -120, -91, 59, -60, -84, -70, 62, -118, -33, 72, -4, -115, 17, 110, 73, -81, -45, 81, -85, -33, -6, 9, 25, 117, 25, 62, -9, -71, 52, 12, 89, -55, -9, 19, -94, 60, -121, 30, 118, 47, -56, -77, -5, -58, -41, -2, 13, 69, -34, -59, 124, -43, -87, 87, -49, -116, -22, 126, -95, -46, 121, -112, -115, -89, 96, 21, 37, -63, 53, 12};

int8_t testInputVectorWeight[2048] ={
      -52, 0, -57, 56, -15, -100, -121, 9, 104, 89,
      6, 89, -56, 44, 8, 15, -85, 82, 73, 38,
      15, -32, -53, -127, -45, -47, 96, -37, -77, 91,
      -125, -96, 119, 104, 106, 13, 116, 92, -100, -25,
       -73, 102, -114, -40, 77, -66, 40, -23, -55, 68,
       -114, 33, -63, -18, 91, 111, 73, 2, -95, 89, 4, 48, 36, -38, 55, 45, -24, -108, -116, 56, 30, -99, 32, -60, -13, 29, 118, -71, 0, 18, 79, -69, -99, 87, -21, 110, -60, 45, -2, 43, 42, -113, -51, 106, 9, 75, 24, -78, -18, -13, -96, 83, 12, 104, -47, 69, 18, 44, 14, 21, -30, 27, -106, 112, 89, -16, 11, 126, -76, 118, 55, 32, -29, 80, 111, 22, 104, 75, 52, 112, -2, -56, -5, 58, 71, -72, -51, 70, 86, -21, 123, 61, -12, -88, 102, -61, -29, 82, -20, 57, -102, 44, -10, 26, -105, -35, 39, -91, 79, 115, 78, -53, 48, -100, 77, -100, 81, 45, 78, -64, 62, -47, 103, -100, -51, 73, 95, 80, 103, 103, -71, -38, -32, -64, 110, -16, -87, 113, -4, -39, 89, -36, 12, -5, -46, -90, 98, 81, -66, 73, 97, 120, -48, 72, 0, -61, 62, 19, 66, -95, -45, 80, 99, 36, -102, -28, 102, 0, -28, 85, 88, 93, -100, -54, -2, 76, 108, 19, -113, 88, 126, 18, 110, -56, 54, 117, 100, -87, 121, -114, -61, -77, -28, 61, -53, 20, 92, -6, 52, 69, 68, -12, -35, -119, 25, -15, 105, 96, 38, -48, 40, 6, -118, -22, 18, -42, 59, -48, 49, -45, 86, 30, -69, 39, -2, -8, 32, -82, 65, -37, 61, 95, 5, -18, 107, -107, -19, 51, -16, 118, -39, 119, 51, -102, 87, 75, -21, 101, -99, -118, -47, 68, -17, -3, 122, 72, -63, -8, -89, -4, -82, -108, 73, 121, 52, -66, 41, -108, -6, 15, -113, 16, 22, -120, -66, 95, 51, 26, -82, -9, 36, -85, -102, 38, 101, -14, -56, -84, -87, -96, 126, -87, 71, -97, 79, -114, -87, -19, -7, 113, 8, -21, 93, -91, -80, 108, 126, -3, 28, 46, 120, 42, -32, 110, 8, 94, -65, -82, 37, -116, 15, 121, -82, -52, 83, -13, -26, 69, -114, -14, -77, 126, 124, 68, -52, -102, 3, 62, -75, -96, -108, -122, 64, 126, -61, 114, -25, 58, 22, -55, -95, 113, -94, -9, 49, -44, 23, 104, -7, 124, -12, 15, -18, -60, 123, -81, 82, 33, 56, 2, -59, 22, -55, 19, 114, -63, -27, -96, -106, 115, -32, 0, 10, -117, -48, 111, -98, 69, 26, -74, 84, 76, -64, 9, 126, 48, -47, -43, 32, -73, -99, -116, 49, 90, -92, -7, -82, 89, 64, 26, -84, 8, -42, -65, 51, 41, 24, 15, 18, -20, -111, 6, -110, -90, 26, 6, 88, -70, 1, -64, 108, -6, -20, -124, -128, 55, -18, -86, 84, 61, 48, 7, -112, 38, 99, -108, -35, 119, 60, -84, -92, 17, -12, -11, 56, -112, 62, -67, -121, -111, -9, 31, -107, -54, 21, 125, -11, 97, -39, 97, 40, -68, 125, -23, -109, 76, 76, 61, -104, -32, -7, -44, -62, -126, -123, 57, 11, -91, -15, 4, -92, 1, 23, -85, -14, 116, 107, -16, -5, -20, -84, 106, -67, -127, 54, -13, -99, -38, -109, 87, 4, 107, -41, -42, -43, 37, 49, 93, 70, 25, 21, -45, -20, 61, 125, -32, 7, 98, -85, 63, -39, 75, 22, 116, 17, 30, 15, -12, -1, 68, 123, -53, 68, -19, -113, 33, 115, -48, 31, -18, 24, 43, -5, -70, -14, 122, -41, -108, -26, 67, -20, -110, -23, -39, -80, -37, 69, -29, 1, 102, 4, -78, 117, -99, 88, 14, -37, -109, 70, 6, 115, 18, -90, -1, -17, 21, -3, 74, 109, 69, 80, 99, -29, 1, -121, -101, -50, -40, -93, -29, 120, 56, -47, 67, -40, 74, 38, 28, -100, -119, -31, 122, 124, -52, -34, -45, -17, 85, -42, -17, 36, 97, 97, -37, -61, 122, 124, -14, 9, -112, 3, 30, -127, 14, -115, -118, -33, -118, -24, 16, -11, -115, -44, -41, -100, 75, -111, -65, 35, 31, 17, -33, -52, -116, 36, 49, 36, -102, 73, 22, -103, -4, 104, 80, -91, -91, -73, 94, 88, 42, 64, -124, 96, -61, 117, 119, 20, -114, 61, -127, 75, -29, 77, 116, -70, -87, -1, -51, -109, -51, 97, 14, -100, 111, 91, -118, 16, 109, 107, 26, 30, 21, 111, 91, 124, -36, 12, -14, 65, 56, 49, 99, -40, -91, -110, 47, 123, -93, 33, -48, -7, 47, -90, -18, 118, -52, 82, 84, 106, 22, -62, 94, 23, 17, 15, -101, 21, -34, 53, 68, 20, 118, 55, 113, -116, 51, 91, 84, 99, -68, -4, -30, 66, 50, 55, -77, 10, 46, -6, 123, 67, 12, -116, -20, 76, -65, 84, -73, -30, -52, -31, -63, 35, 39, -95, -1, -92, 111, 78, -8, 12, 117, -96, 57, 15, -13, 116, -78, 24, -94, -16, -113, -112, -117, -55, -72, -29, -109, 120, 49, 30, -100, -38, 38, -25, -28, 112, 91, 53, 21, 34, 64, 14, 2, 82, -95, 80, -68, 109, -77, -5, 93, 87, -5, 107, 36, 9, 1, -89, 86, -88, -106, -59, 91, -113, 7, -118, 77, 85, -66, 66, -45, 4, 81, 92, 19, -71, -116, 68, -8, -46, 53, -85, 38, 118, 103, 37, -84, 98, 57, 93, 82, 68, -124, 3, -20, -9, -79, 102, 100, 36, 23, 112, 78, 69, 78, -116, 20, -85, 72, 39, 123, 73, 75, -44, -22, -5, 78, -83, -22, 124, -78, 83, -15, -119, 1, 33, 122, 88, 80, 91, -124, 84, 62, 50, -5, 45, 105, -65, -100, 34, -61, -71, -70, 91, -12, -13, -65, -91, 95, -39, -71, -93, -41, -86, -8, -73, 81, -99, 112, -72, 67, 88, -112, -43, -67, 100, -75, -105, -11, -56, 92, -11, -51, 70, -14, -28, -99, 6, -92, 34, 111, 57, -86, 34, 23, -1, 69, -39, 102, 14, -111, -71, 120, -33, -78, -111, -124, -53, 77, 40, -86, 31, -15, 17, 54, 101, 5, -90, -81, -19, -10, 22, 93, -3, 115, -42, 33, 40, 13, -23, -117, 110, 26, -123, -77, 10, 79, -67, -119, -82, 93, 2, 122, -15, -123, -70, -7, -54, -70, -31, 107, 37, 80, 57, 71, -17, -116, 5, 69, -79, 112, -24, -56, 91, 55, 121, 88, -89, 120, -33, -27, 99, 115, 16, 89, 32, -65, -12, 80, -104, 50, -63, -69, 34, 4, 3, 37, 42, -100, -7, 110, 57, 44, -117, 4, -31, -46, -118, -86, -65, 15, -35, -2, -117, -25, -126, -8, 51, -1, -24, -83, -72, 107, 73, -101, 9, 106, -6, 53, -11, 79, 94, -46, -86, 116, 41, 85, 24, 56, -99, 71, 61, 74, -104, 67, 24, -49, 20, -119, -17, -5, 28, 109, -68, 75, 83, 125, 36, 113, 54, -125, 3, 96, 60, -80, -64, 94, -112, -43, 3, 5, 118, -119, -30, -30, -43, 69, -24, 78, 105, -40, 112, 103, -3, 64, 110, -10, -61, -26, 52, -24, -38, 89, 108, 15, 42, 103, -128, 94, 5, -32, 22, -116, 59, -44, 100, 59, -120, 59, -126, -116, -83, 28, 87, 44, 46, -116, 88, -46, -70, 37, -92, 122, -127, -6, 20, 22, -86, -88, -116, 32, 89, 112, -71, -25, -9, 91, 126, -81, -88, 57, 54, -113, 57, -56, 24, 53, 37, 125, -35, -16, -32, 112, 96, -24, -86, -55, 40, 109, -86, 11, 106, -49, 73, -25, -127, -115, 36, -58, 47, -87, -55, 82, -13, -36, 120, -76, -89, 37, -115, -118, 104, 5, -78, -93, -103, 69, 114, -34, -90, -102, 105, -124, -34, 16, -112, 36, -98, -51, -55, 18, 121, 46, 26, -26, 66, -4, -53, -9, 53, -39, 73, 123, 1, -34, -123, 45, 57, -15, 78, -13, -77, -60, -126, -49, 126, -125, -58, -90, 27, -69, 117, -24, -37, 23, 39, 19, -53, 100, -1, -23, -22, 98, 38, 104, -73, 66, 28, -71, 109, 85, -125, -82, 58, 9, -123, -46, -1, -59, -38, 115, -20, -115, -36, 45, -55, 101, 7, -80, 28, 23, 27, -46, -4, -85, 26, -108, 13, 54, 47, 88, 66, -23, -5, -35, -30, 44, -40, 53, -36, -84, 121, 113, 61, 13, 49, -13, -110, 76, 33, -104, 9, 97, -112, 122, -74, -94, -46, -72, -110, 21, 111, 15, 37, 9, -26, -85, -124, -2, -120, 124, -72, -39, -84, -3, -100, -97, 68, -26, -113, -18, -73, -8, 28, -26, -75, -112, -95, 68, -26, -29, -91, 94, 118, -91, -115, 58, 121, -88, -70, 53, -22, -11, -124, 43, 15, 47, -49, -34, 58, 63, -57, -91, -57, -116, 37, 84, -55, -93, 108, -54, 56, -128, -106, 116, 78, 92, 63, -61, -53, -48, 62, -117, 77, 40, 62, 91, 64, 21, -22, -49, -26, -72, -123, 43, -95, -115, 19, -66, -116, 118, -45, -77, -88, -103, 61, 29, 15, -1, 41, -65, 5, 92, 48, 18, 88, -67, 14, 43, -46, -107, 19, -102, 94, -33, 22, -15, 99, -60, -86, 85, -93, 109, 75, 103, 72, 67, -31, 47, -30, 96, 99, 70, -21, 37, -24, -112, -25, 49, 111, 86, -99, 81, 35, -128, 56, 7, -52, 122, 122, -86, 1, -82, -57, 37, 118, -40, -9, 16, 95, -7, 31, 102, 35, -106, 10, 81, -121, 105, 12, -87, 42, 95, 58, -102, 17, -4, 11, -110, 74, 103, -47, 27, 108, 88, 121, -55, -126, 60, -109, 121, 65, -116, -32, -115, 55, 12, 50, -82, -50, 95, -82, -119, -118, -23, 84, -95, -27, -97, -59, -20, 99, -14, -20, 88, 89, -73, 91, -99, -66, 78, 11, -86, 93, -55, -56, -46, -117, 31, -10, 64, -89, -30, 19, 87, -31, 122, 117, -75, -76, -72, 124, -25, -27, -23, -57, -87, 80, -11, -98, -23, 26, 23, 68, 41, 120, 29, 71, -75, -94, 51, -24, -117, 46, -19, 49, -93, -104, -71, 118, 93, -9, 81, 34, -7, 79, -41, 0, 37, -88, 105, -110, -18, -84, -93, 30, -50, -77, 77, -114, -45, 113, -25, 64, 82, 57, -30, 103, 36, 112, 89, 3, -70, -78, -16, -95, 78, -72, 11, -101, 2, -40, 50, 98, -102, 96, 30, -12, 44, -69, -107, -103, 14, -87, -125, -4, 16, -95, -74, 11, -73, -76, -118, 41, -43, 64, 52, -22, 19, 60, 48, -22, 40, 119, 29, -109, 90, 60, 38, 102, 53, -15, 106, 70, 43, 78, -71, 14, -53, 126, 58, -77, -21, 77, -112, -98, 87, 47, 11, 126, 55, 84, 89, -96, 103, -110, 53, -83, -15, -34, -120, -63, -66, 45, 1, -76, 72, 48, 108, -123, 108, -38, -122, 12, 84, 52, 62, -40, -67, -124, 60, -22, -1, -103, -56, -46, -111, 8, -63, -29, 86, 36, 103, 53, 88, 117, 109, -33, 7, -26, 23, 19, 52, 46, -15, 64, 80, 35, 66, -44, 21, 100, -122, 103, -76, 73, 109, -80, 57, 81, -77, -123, -78, 57, 75, -7, 82, 104, -47, -124, -89, 77, -101, 13, -13, -57, 19, -6, 83, 34, 13, -118, 80, 93, -12, 19, -102, -88, 68, 58, -11, 31, 2, -26, -99, 70, 125, -29, 116, -91, 97, -104, -115, -47, -19, -93, -46, -13, -50, -19, 54, -55, 41, -89, -48, 9, 63, 23, 54, -26, 108, 43, -123, -56, -78, -25, 44, 13, -39, -33, 87, -26, 20, -106, -41, 51, -47, 84, 40, -16, 68, -30, -104, 99, 60, 31, 74, -111, 98, 77, 97, -68, 30, -10, -86, 4, -10, -110, -62, 53, -120, 97, -89, 40, -47, -3, -38, -70, -104, 115, 92, 92, -33, -16, 0, -44, -121, -11, 89, 62, 32, -102, 12, -11, -47, 115, 125, -88, 97, -126, -121, 35, -53, 2, -18, 93, -63, 30, 95, -55, 13, 22, 18, -35, -1, -44, -83, 90, -37, 33, -78, 63, 63, -116, 54, 4, -16, -8, 70, -35, -14, -54, -80, 41, -72, 99, 50, 23, 23, -60, 62, -33, 115, 53, 91, 55, 83, 37, 30, -3, 96, 83, -46, -109, -96, 91, 79, 105, -116, 107, -83, 34, -56, 107, -77, -55, -127};

int16_t testInputVectorBias[128] ={-10734, 32, -2293, -29764, 1700, -2334, 8355, -29127, 31588, -2479, 25430, -13741, -28706, -11201, -12113, -7076, -20453, -23812, 19285, 23050, -646, 13541, 13665, 14495, -10684, -23852, 28482, -13025, 32200, 32157, 8986, 2710, -9195, -7958, 23160, -19295, 11683, -21678, -3012, -23402, 22690, 23306, -30381, -6569, -15425, -4925, 804, 16609, 23993, -29701, 22541, 14688, -4302, 29121, 19614, 23065, -4055, 26337, -32185, 31498, 19918, 12621, -23130, -11188, 27566, -18918, -19421, -6539, 6086, -12352, -14445, -2, 26804, -9867, 24054, 5369, 1997, 1773, -6700, 9966, -8694, 9809, 11526, -10920, -12636, -12441, 16251, -27573, 9076, -12722, 26866, -23376, -24215, 22823, 8958, -31539, 31225, 27959, 22584, -32271, -17131, 16982, 9034, -31126, 32058, -11087, -30093, 3988, -8635, 12451, -30057, 828, 2714, -19989, 30434, -5804, 30362, 22874, 17757, 23599, -18151, 11499, -29201, 1922, 22051, -24202, 1005, -4145};

char *s[100];
  void cluster_fork(void *args) {

	  printLog("cluster fork \n\r");
      // Unpack args
      char *I = ((char **)args)[0];
      char *W = ((char **)args)[1];
      char *B = ((char **)args)[2];
      char *O = ((char **)args)[3];
      int S = ((int *)args)[4];
      int E = ((int *)args)[5];
      int P = ((int *)args)[6];
      int H = ((int *)args)[7];
      int requantDiv = ((int *)args)[8];
      int requantMul = ((int *)args)[9];

      char *base = I;

      for(int i=0;i<256;i++)
      {
    	  sprintf(s, "%02x ", testInputVectorInput[i]);
    	  printLog(s);
    	  if(i % 16 ==0)
    		  printLog("\n\r");
      }


      // Set test inputs, weights, and biases
      I=(char *)&testInputVectorInput;
      W=(char *)&testInputVectorWeight;
      B=(char *)&testInputVectorBias;

      for (int i = 0; i < 256; i++) {
    	  I[i] = (int8_t)testInputVectorInput[i];
      }
      for (int i = 0; i < 2048; i++) {
          W[i] = (int8_t)testInputVectorWeight[i];
      }
      int16_t* B16 = (int16_t*) B;
      for (int i = 0; i < 128; i++) {
          B16[i] = (int16_t)testInputVectorBias[i*2];
      }

      // Perform multi-head attention operations
      for(int i=0; i < 2; i++){
          linearQK_4x2_H(I, W, B, O, 16, 16, 16, 8, 16, 385);
      }

      linearV_4x2_H(I, W, B, O, 16, 16, 16, 8, 16, 385);

      I = base; W = base + 256; O = base + 256 + 256;
      for(int i=0; i < 8; i++){
          matmulSoftmax_4x2_S(I, W, O, 16, 16, 1, 16, 385, 1, 7, 24, 5, 256);
      }

      I = base; W = base + 256; O = base + 256 + 256;
      for(int i=0; i < 8; i++){
          matmul_4x2_S(I, W, O, 16, 16, 1, 16, 385);
      }

      I = base; W = base + 2048; O = base + 2048 + 2048;
      linearO_4x2_H(I, W, B, O, 16, 16, 16, 8, 16, 385);

  }

void kernel_task(void *task_args) {

  char* L1_buffer = malloc(80000);

  // Create L1 tensor pointers
  printf("Declare Buffer Pointers: ");
  char *A = (char *) (L1_buffer + 64);
  char *Bias = (char *) (L1_buffer + 64 + 320);
  char *B = (char *) (L1_buffer + 64 + 2432);
  char *O = (char *) (L1_buffer + 64 + 4544);
  printf("DONE\n");
  
   // Build agrs to give to cluster
  unsigned int args[10] = {
    A,
    B,
    Bias,
    O,
    16,
    16,
    16,
    8,
    16,
    385
  };

  cluster_fork(args);
  free(L1_buffer);
}

int submain () {

//  char* L1_buffer;
  char* L2_buffer;

  printf("Configure mcu: ");
  printf("DONE\n");

  printf("Allocate L2: ");
  L2_buffer = malloc(700000);
  printf("DONE\n");

  unsigned int empty_args[0] = {};

  // Start cluster job
  printf("Start Cluster Task");
  // Prepare Task
  kernel_task(empty_args);

  // Close the cluster
  printf("End Cluster Task");
  free(L2_buffer);
}
